VPN-Setup And Firewall
======================

This directory contains the files and settings for the firewall and OpenVPN at
rwthCTF 2012. Overview:

 * sysctl.sh -- optimize kernel configuration, disable ipv6, enable ipv4-forwarding
 * openvpn/ -- OpenVPN config files and templates
 * ferm.conf -- Firewall configuration file for ferm (http://ferm.foo-projects.org/)

Overview/Architecture
---------------------

At rwthCTF 2012 we used an octa-core Intel i7 with 16GB RAM exclusively for
hosting the VPN and the firewall. Since OpenVPN is running as a user land
single thread, we decided to split the load over eight distinct OpenVPN
processes, so that the full computing capacity of the machine is utilized. We
also decided not to expose this to the participants and let the firewall
forward new incoming VPN connections to an OpenVPN instance. The OpenVPN
processes each listened on a distinct UDP port. From the Internet, all
participants connected to port 1194 of our firewall. When the first UDP packet
is received, one instance is selected and this and all following UDP packets
are forwarded to that instance.

Network
-------

The game took place within the network 10.12.0.0/16. All participating teams
were allocated a /24 network within 10.12.0.0/17, e.g. team 5 was assigned the
network 10.12.5.0/24. During preparation, the rwthCTF staff used the networks
10.12.129.0/24 to 10.12.141.0/24 to connect to the network.

The VPN gateway had three network interfaces: eth0 (137.226.161.28/24) was the
public interface where teams' connected to via VPN, eth1 (10.12.250.2/24) was
the internal network which hosted the staff workstations and servers. The third
network interface eth2 was connected to a separated logging server at
192.168.1.23/24.

OpenVPN configuration
---------------------

The eight OpenVPN instances were configured to listen on the UDP ports 10501 to
10508 and use the devices tun1 to tun8. Each VPN client is assigned a transport
IP address from a network depending on the selected instance. The transport
networks are 10.12.201.0/24 to 10.12.208.0/24.

After authentication to the selected OpenVPN instance, the route for this
team's network has to be set within OpenVPN.  This is achieved by setting
client-config-dir to "ctfclients" and creating a file with the CommonName of
the team's certificate, which contains additional OpenVPN configuration
commands executed only when this team connects.  A sample config file for team
5 is included at openvpn/ctfclients/team5.ctf.itsec.rwth-aachen.de, which
contains:

    iroute 10.12.5.0 255.255.255.0

The route to this team's network must also be corrected in the operating
system's routing table. This task is done by the "learn-address" script, which
is called by OpenVPN after a client has successfully authenticated.
Unfortunately, the OpenVPN configuration file does not allow passing additional
parameters to this script, so we hardcoded the correct tun-device in each
instance's learn-script. Since OpenVPN is running as the low-privileged user
"nobody" these scripts are also executed as that user. Therefore the
learn-scripts use sudo to set routes to client networks, this is configured by
calling "visudo" and inserting the following entry:

    nobody ALL= NOPASSWD: /bin/ip

Config Templates
----------------

Since we were soon tired of adapting each OpenVPN instance's configuration file
and learn-script to configuration changes, we wrote a small script to generate
these files from templates.  The templates were saved in openvpn/templates/:

    $ ls openvpn/templates
    generate
    learn-server.sh.template
    server.conf.template

We also included a Makefile within the openvpn-directory, the configuration
files and learn-scripts can be generated by calling "make all" in this
directory.

Firewall
--------

The firewall is configured with ferm from the configuration file "ferm.conf".
The most important quality of ferm is the interactive mode: When a new firewall
configuration is loaded via "ferm -i /etc/ferm/ferm.conf", ferm asks for a
confirmation (you have to type "yes"), when this is not received within a few
seconds, the old firewall is rolled back.

For rwthCTF 2012 we used vservers to separate the different services. These
vservers all had an IP address with the last byte below 16, e.g. a vserver of
team 5 was reachable at 10.12.5.3.  The players were requested to use IP
addresses with the last byte set to a value above 16, so all traffic to
services can be match by using the network and netmask
10.12.0.0/255.255.128.240.

During the game, the teams were only allowed to contact the game server (at
10.12.250.1) and the other teams' vulnerable services, but not the transport
networks, the other teams' players or anything not part of the game.

The teams should not be able to distinguish the game server (at 10.12.250.1)
from other teams' clients, therefore all traffic that is going out to the VPN
is masqueraded behind the IP addresses 10.12.253.10 to 10.12.253.20. Several IP
addresses were used for masquerading so that a huge number of parallel
connections can be masqueraded, typically one masqueraded connection blocks one
source port for the masqueraded IP address.  Furthermore, the TTL of outgoing
IP packets is always set to 42 and TCP timestamps are stripped.

Before the game, rwthCTF staff was also using VPN with special certificates
which were routed the networks 10.12.129.0/24 to 10.12.141.0/24, especially
these networks were not contained within 10.12.0.0/17.

All traffic between teams was sent to a separate server by using the TEE target
of iptables for logging the complete traffic with tcpdump. Afterwards the dumps
were published.

